{% extends 'MC_command/base.html' %}

{% block title %}{{ form_title }}{% endblock %}

{% block extra_head %}
{# The inline styles have been moved to style.css for better maintainability #}
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header"><h1>{{ form_title }}</h1></div>
    <div class="card-body">
        <form method="post" novalidate>
            {% csrf_token %}

            <fieldset>
                <legend>基本配置</legend>
                {% if form.non_field_errors %}
                    <div class="errorlist">
                        {% for error in form.non_field_errors %}
                            <p>{{ error }}</p>
                        {% endfor %}
                    </div>
                {% endif %}

                {% for field in form %}
                    <div class="form-field">
                        {{ field.label_tag }}
                        {{ field }}
                        {% if field.help_text %}<small style="color: #666;">{{ field.help_text }}</small>{% endif %}
                        {{ field.errors }}
                    </div>
                {% endfor %}
            </fieldset>

            {% for prefix, data in component_data.items %}
            <div class="inline-group component-group" id="{{ prefix }}-group"
                 data-prefix="{{ prefix }}"
                 data-supported-types="{{ data.supported_types }}"
                 style="display: none;">
                <h2>{{ data.verbose_name }}</h2>
                <div class="inline-group-content">
                    {{ data.formset.management_form }}
                    <table>
                        <thead>
                            <tr>
                                {% for field in data.formset.empty_form %}{% if not field.is_hidden %}<th>{{ field.label }}</th>{% endif %}{% endfor %}
                                {% if data.formset.can_delete %}<th>☯</th>{% endif %}
                            </tr>
                        </thead>
                        <tbody id="{{ prefix }}-form-container">
                            {% for form in data.formset %}
                            <tr id="{{ form.prefix }}-row">
                                {% for field in form.hidden_fields %}{{ field }}{% endfor %}
                                {% for field in form.visible_fields %}{% if field.name != 'DELETE' %}<td>{{ field }}{{ field.errors }}</td>{% endif %}{% endfor %}
                                {% if data.formset.can_delete %}<td>{{ form.DELETE }}</td>{% endif %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <button type="button" class="add-row-btn" data-formset-prefix="{{ prefix }}">添加 {{ data.verbose_name }}</button>
                    <template id="{{ prefix }}-empty-form-template">
                        <tr>
                            {% for field in data.formset.empty_form.hidden_fields %}{{ field }}{% endfor %}
                            {% for field in data.formset.visible_fields %}{% if field.name != 'DELETE' %}<td>{{ field }}</td>{% endif %}{% endfor %}
                            {% if data.formset.can_delete %}<td>{{ data.formset.empty_form.DELETE }}</td>{% endif %}
                        </tr>
                    </template>
                </div>
            </div>
            {% endfor %}

            <div class="form-actions" style="margin-top: 25px;">
                <button type="submit" class="btn">保存</button>
                <a href="{% if command %}{% url 'MC_command:detail' command.id %}{% else %}{% url 'MC_command:index' %}{% endif %}" class="cancel-link" style="margin-left: 15px;">取消</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- 数据准备 ---
    const itemTypeSelect = document.getElementById('id_item_type');
    const componentGroups = document.querySelectorAll('.component-group');
    let itemTypeData = {};
    try {
        itemTypeData = JSON.parse('{{ item_type_data_json|escapejs|default:"{}" }}');
    } catch (e) {
        console.error("解析 item_type_data_json 失败:", e);
    }

    // --- 核心功能: 根据物品类型更新组件的可见性 ---
    const updateComponentVisibility = () => {
        const selectedItemTypeId = itemTypeSelect.value;
        let currentItemFuncType = 'all'; // 默认功能类型

        if (selectedItemTypeId && itemTypeData[selectedItemTypeId]) {
            currentItemFuncType = itemTypeData[selectedItemTypeId].type;
        }

        componentGroups.forEach(group => {
            try {
                const supportedTypes = JSON.parse(group.dataset.supportedTypes);
                // 检查组件是否支持 'all' 或当前物品的功能类型
                if (supportedTypes.includes('all') || supportedTypes.includes(currentItemFuncType)) {
                    group.style.display = ''; // 显示
                } else {
                    group.style.display = 'none'; // 隐藏
                }
            } catch (e) {
                console.error(`解析组件 ${group.id} 的 supported-types 失败:`, e);
                group.style.display = 'none';
            }
        });
    };

    // --- 表单集逻辑: 添加新行 ---
    document.querySelectorAll('.add-row-btn').forEach(button => {
        button.addEventListener('click', function() {
            const prefix = this.dataset.formsetPrefix;
            const container = document.getElementById(`${prefix}-form-container`);
            const totalFormsInput = document.getElementById(`id_${prefix}-TOTAL_FORMS`);
            let totalForms = parseInt(totalFormsInput.value);
            const template = document.getElementById(`${prefix}-empty-form-template`);
            
            // 创建新行并替换前缀
            const newRowHtml = template.innerHTML.replace(/__prefix__/g, totalForms);
            const newRow = document.createElement('tr');
            newRow.innerHTML = newRowHtml;
            container.appendChild(newRow);
            
            totalFormsInput.value = totalForms + 1;
        });
    });

    // --- 事件监听 ---
    itemTypeSelect.addEventListener('change', updateComponentVisibility);

    // --- 页面加载时初始化 ---
    updateComponentVisibility();
});
</script>
{% endblock %}