{% extends 'MC_command/base.html' %}

{% block title %}命令详情: {{ command.title }}{% endblock %}

{% block content %}
    <div class="card">
        <div class="card-header">
            <h1>{{ command.title }}</h1>
        </div>
        <div class="card-body">
            <div class="details-grid">
                <dt>创建者:</dt> <dd>{{ command.user.username }}</dd>
                <dt>目标版本:</dt> <dd>{{ command.target_version.version_number }}</dd>
                <dd>{{ command.item_name }} (<code>{{ command.item_id }}</code>)</dd>
                <dt>数量:</dt> <dd>{{ command.count }}</dd>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h2>生成结果</h2>
        </div>
        <div class="card-body">
            <p><strong>完整 /give 命令</strong> (可直接在游戏中使用)</p>
            <div class="textarea-container">
                <textarea id="give-command" readonly>{{ give_command_string }}</textarea>
                <button class="copy-btn" onclick="copyToClipboard('give-command')">复制</button>
            </div>

            <p><strong>数据结构 (JSON)</strong> (用于调试或理解结构)</p>
            <div class="textarea-container">
                <textarea id="data-json" readonly>{{ data_structure_json }}</textarea>
                <button class="copy-btn" onclick="copyToClipboard('data-json')">复制</button>
            </div>
        </div>
    </div>
    
    <div class="card">
        <div class="card-header">
            <h2>配置详情</h2>
        </div>
        <div class="card-body">
            {% if command.custom_name or command.lore %}
                <h3>显示属性</h3>
                <ul>
                    {% if command.custom_name %}<li><strong>自定义名称:</strong> <code>{{ command.custom_name }}</code></li>{% endif %}
                    {% if command.lore %}<li><strong>Lore:</strong> <pre>{{ command.lore }}</pre></li>{% endif %}
                </ul>
                <hr>
            {% endif %}

            {% if command.enchantments.all %}
                <h3>附魔</h3>
                <ul>
                {% for applied_enchantment in command.enchantments.all %}
                    <li>{{ applied_enchantment.enchantment.name }} - 等级 {{ applied_enchantment.level }}</li>
                {% endfor %}
                </ul>
                <hr>
            {% endif %}

            {% if command.attributes.all %}
                <h3>属性修改器</h3>
                <ul>
                {% for attr in command.attributes.all %}
                    <li>
                        {{ attr.attribute.name }}: <strong>{{ attr.amount }}</strong> 
                        (操作: {{ attr.get_operation_display }}, 槽位: {{ attr.get_slot_display }})
                        {% if attr.modifier_name %}<small> [旧版名称: {{ attr.modifier_name }}]</small>{% endif %}
                    </li>
                {% endfor %}
                </ul>
            {% endif %}

            {% if command.potion_effects.all %}
                <hr>
                <h3>药水效果</h3>
                <ul>
                {% for p_effect in command.potion_effects.all %}
                    <li>
                        {{ p_effect.effect.name }}: 等级 <strong>{{ p_effect.amplifier }}</strong>, 持续时间 <strong>{{ p_effect.duration }}</strong> ticks
                    </li>
                {% endfor %}
                </ul>
            {% endif %}
            
        </div>
    </div>
    
    <a href="{% url 'MC_command:index' %}" class="btn btn-secondary">返回上一页</a>
{% endblock %}

{% block extra_js %}
    <script>
        function copyToClipboard(elementId) {
            const textarea = document.getElementById(elementId);
            textarea.select();
            textarea.setSelectionRange(0, 99999); // For mobile devices
            try {
                navigator.clipboard.writeText(textarea.value);
                alert('已复制到剪贴板！');
            } catch (err) {
                alert('复制失败，请手动复制。');
            }
        }
    </script>
{% endblock %}